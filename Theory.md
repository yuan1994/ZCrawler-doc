# 原理解读

ZCrawler 利用 PHP 代码进行模拟登录，实现模拟学生登录教务网获取课表、成绩等网页数据，然后利用解析器将数据解析成规范格式输出。


## HTTP 请求

HTTP 请求是无状态的，也就是服务器不会记住下一次请求是不是来自于你，但是客户端与服务器交互是肯定需要状态确认的，即你在该客户端操作，服务器端知道是你在操作，所以就有 session 会话机制，session 会话机制是服务器端生成一个认证文件或者缓存，记录客户端的信息，例如用户id，然后生成一个 session_id，这个 session_id 在请求完成后会在响应中一起带回客户端，然后客户端将这个 session_id 存储为 cookie，这个 cookie 就是一种很特殊的 cookie，也叫 session cookie, 以后客户端发送请求时都会带上该 cookie，然后服务器端识别该 cookie，确定该 cookie 中的 session_id 对应的哪个用户，这样就做了 "有状态"。说了这么多，无非是在强调，只要让服务器端有这个 cookie，不管是学生真人在浏览器上操作还是利用代码模拟人工操作发送请求，只要有有效的 cookie，就能实现一个正常的帐号访问教务网，获取学生的课表、成绩等信息。

HTTP 请求主要使用的有两种，GET 和 POST 请求，学生登录教务网在浏览器上操作，实际上也是通过浏览器向服务器发送 GET/POST 请求，所以完全可以利用代码完成 HTTP 请求发送，并对响应进行处理。


## 如何获取请求参数与请求方式？

使用网络抓包工具，可以轻松获取 HTTP 请求的请求方式、参数已经响应等各种信息，在 Windows 系统上很流行的抓包工具主要是 Fiddler4，在 Mac 上有优秀的 Charles 抓包神器，在 Linux 上可视化的抓包工具很少，Linux 版的 Fiddler 很是不稳定，所以不建议在 Linux 系统上开发测试。

利用抓包工具获取到请求方式、请求地址、请求参数（包括 cookie、头信息），然后利用代码进行模拟请求测试，可以发现也能请求成功，并获取到预期的响应。


## 如何绕过验证码？

验证码是为了区分请求是来自人还是机器的一种安全机制，但现在的人工智能特别发达，简单的验证码也能通过代码进行图像处理识别出来，实现验证码机器识别，但是这样做成本高，而且准确率不能达到 100%。幸好，【正方教务】给留了很多漏洞，很多登录地址不需要验证码，这个就自己去网站找然后测试了。


## 如果验证码绕过不了怎么办？

先说说验证码如何实现人机验证。验证码一般由服务器端生成一个 session，然后将验证码的正确值存储到 session 中，然后利用图片干扰技术，生成的带文字的并带有干扰噪点的图片。所以，要完成验证码验证，下次请求将此 session，也就是客户端获取到的 cookie 传递给服务器并带上人工填写的验证码即可，不需要一定要在浏览器上完成。所以，可以先进行模拟请求获取到验证码图片并保存到本地，然后缓存 cookie，待人工识别验证码后，将识别后的字符串以及其他请求参数、cookie 一起传递到服务器，这样就实现了远程验证码抓取、人工识别验证码。


## 登录成功后如何获取课表、成绩？

登录成功后，服务器会返回一个 cookie 给客户端，，这个 cookie 里带的 session_id 是服务器端完成了身份验证的 session_id，下次请求带上该 cookie，服务器就认为该请求已经登录过帐号，是合法请求，这样，只要有合法的请求方式、请求地址、请求参数，就能发送一个合法的请求获取用户信息，请求成功后返回的是查询成功后的网页，即 HTML 代码，然后对 HTML 代码进行解析获取想要的数据即可。
